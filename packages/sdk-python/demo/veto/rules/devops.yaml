version: "1.0"
name: devops-infrastructure-rules
description: Security rules for DevOps infrastructure agent

rules:
  # =============================================================================
  # SHELL COMMAND RULES
  # =============================================================================

  - id: block-destructive-commands
    name: Block destructive shell commands
    description: |
      Prevent execution of commands that can cause irreversible damage:
      - rm -rf (recursive force delete)
      - mkfs (format filesystem)
      - dd (disk destroyer if misused)
      - chmod 777 (dangerous permissions)
      - > /dev/sda (write to disk device)
    enabled: true
    severity: critical
    action: block
    tools:
      - execute_command
      - run_shell
    conditions:
      - field: arguments.command
        operator: contains
        value: "rm -rf"

  - id: block-sudo-commands
    name: Block privilege escalation
    description: Prevent sudo and su commands that elevate privileges
    enabled: true
    severity: critical
    action: block
    tools:
      - execute_command
      - run_shell
    conditions:
      - field: arguments.command
        operator: starts_with
        value: "sudo"

  - id: block-system-destruction
    name: Block system destruction commands
    description: Prevent commands that can destroy the system
    enabled: true
    severity: critical
    action: block
    tools:
      - execute_command
      - run_shell
    conditions:
      - field: arguments.command
        operator: contains
        value: "mkfs"

  # =============================================================================
  # DEPLOYMENT RULES
  # =============================================================================

  - id: block-prod-deploy
    name: Block production deployments
    description: |
      Production deployments require human approval through proper CI/CD.
      This prevents accidental or unauthorized production releases.
    enabled: true
    severity: critical
    action: block
    tools:
      - deploy_service
    conditions:
      - field: arguments.environment
        operator: equals
        value: "production"

  - id: allow-staging-deploy
    name: Allow staging deployments
    description: Staging and development deployments are permitted
    enabled: true
    severity: low
    action: allow
    tools:
      - deploy_service
    conditions:
      - field: arguments.environment
        operator: in
        value:
          - "staging"
          - "development"
          - "dev"
          - "test"

  # =============================================================================
  # DATABASE RULES
  # =============================================================================

  - id: block-drop-table
    name: Block DROP TABLE on production
    description: Prevent DROP TABLE/DATABASE on production databases
    enabled: true
    severity: critical
    action: block
    tools:
      - query_database
    conditions:
      - field: arguments.query
        operator: contains
        value: "DROP"

  - id: block-delete-queries
    name: Block DELETE queries on production
    description: Prevent DELETE statements on production databases
    enabled: true
    severity: critical
    action: block
    tools:
      - query_database
    conditions:
      - field: arguments.query
        operator: contains
        value: "DELETE"

  - id: block-truncate-queries
    name: Block TRUNCATE queries on production
    description: Prevent TRUNCATE statements on production databases
    enabled: true
    severity: critical
    action: block
    tools:
      - query_database
    conditions:
      - field: arguments.query
        operator: contains
        value: "TRUNCATE"

  - id: allow-read-only-queries
    name: Allow read-only database queries
    description: SELECT queries are always permitted for reporting and debugging
    enabled: true
    severity: low
    action: allow
    tools:
      - query_database

  # =============================================================================
  # CREDENTIAL ACCESS RULES
  # =============================================================================

  - id: block-credential-access
    name: Block credential and secret access
    description: |
      Prevent access to sensitive credentials and secrets.
      Credentials should only be accessed through secure vaults.
    enabled: true
    severity: critical
    action: block
    tools:
      - read_file
      - execute_command
    conditions:
      - field: arguments.path
        operator: contains
        value: "credentials"

  - id: block-env-secrets
    name: Block .env and secret files
    description: Prevent reading environment files with secrets
    enabled: true
    severity: critical
    action: block
    tools:
      - read_file
    conditions:
      - field: arguments.path
        operator: contains
        value: ".env"

  # =============================================================================
  # SAFE OPERATIONS (Always Allowed)
  # =============================================================================

  - id: allow-status-checks
    name: Allow service status checks
    description: Checking service health is always permitted
    enabled: true
    severity: low
    action: allow
    tools:
      - check_service_status

  - id: allow-log-viewing
    name: Allow log viewing
    description: Reading logs for debugging is always permitted
    enabled: true
    severity: low
    action: allow
    tools:
      - view_logs

  - id: allow-metrics
    name: Allow metrics queries
    description: Querying metrics and monitoring data is always permitted
    enabled: true
    severity: low
    action: allow
    tools:
      - get_metrics
